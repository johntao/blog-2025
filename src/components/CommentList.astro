---
import { supabase } from '../lib/supabase'

const { slug } = Astro.props
const postSlug = slug || Astro.url.pathname

// Fetch approved comments - this runs at build time
const { data: comments } = await supabase
  .from('comments')
  .select('*')
  .eq('post_slug', postSlug)
  .eq('approved', true)
  .order('created_at', { ascending: false })

const commentCount = comments?.length || 0
---

<div class="comments-section" data-slug={postSlug}>
  <h3>
    {commentCount === 0 ? 'No comments yet' : 
     commentCount === 1 ? '1 Comment' : 
     `${commentCount} Comments`}
  </h3>
  
  {commentCount === 0 ? (
    <p class="no-comments">Be the first to comment!</p>
  ) : (
    <div class="comments-list">
      {comments?.map((comment, index) => (
        <div class="comment" id={`comment-${comment.id}`}>
          <div class="comment-header">
            <span class="comment-number">#{commentCount - index}</span>
            <span class="separator">|</span>
            <strong class="comment-author">{comment.author_name}</strong>
            <span class="separator">|</span>
            <time class="comment-date">
              {new Date(comment.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
              })}
            </time>
          </div>
          <div class="comment-content">{comment.content}</div>
        </div>
      ))}
    </div>
  )}
</div>

<style>
  .comments-section {
    margin: 1.5rem 0;
  }

  .comments-section h3 {
    margin-bottom: 1.5rem;
  }

  .no-comments {
    color: var(--color-text, #d8d4d6);
    opacity: 0.6;
    font-style: italic;
    font-family: monospace;
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-top: 1rem;
  }

  .comment {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .comment-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--color-border, #404040);
    font-family: monospace;
    font-size: 0.9rem;
  }

  /* .comment-number { */
  /*   color: var(--color-hyprlink, #75bfff); */
  /*   font-weight: normal; */
  /* } */

  .separator {
    color: var(--color-text, #d8d4d6);
    opacity: 0.5;
  }

  .comment-author {
    color: var(--color-text, #d8d4d6);
    font-weight: normal;
  }

  .comment-date {
    color: var(--color-text, #d8d4d6);
    font-size: 0.9rem;
    font-family: monospace;
  }

  .comment-content {
    color: var(--color-text, #d8d4d6);
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: inherit;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--color-border, #404040);
    border-top: none;
  }
</style>
