---
import { supabase } from '../lib/supabase'

const { slug } = Astro.props
const postSlug = slug || Astro.url.pathname

// Fetch approved comments - this runs at build time
const { data: comments } = await supabase
  .from('public_comments')
  .select('*')
  .eq('post_slug', postSlug)
  .order('created_at', { ascending: false })

const commentCount = comments?.length || 0
---

<div class="comments-section" data-slug={postSlug}>
  <h3 class="comments-heading">
    {commentCount === 0 ? 'No comments yet' :
     commentCount === 1 ? '1 Comment' :
     `${commentCount} Comments`}
  </h3>

  {commentCount === 0 ? (
    <p class="no-comments">Be the first to comment!</p>
  ) : (
    <div class="comments-list">
      {comments?.map((comment, index) => (
        <div class="comment">
          <div class="comment-header">
            <span class="comment-number">#{commentCount - index}</span>
            <span class="separator">|</span>
            <strong class="comment-author">{comment.author_name}</strong>
            <span class="separator">|</span>
            <time class="comment-date">
              {new Date(comment.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
              })}
            </time>
          </div>
          <div class="comment-content">{comment.content}</div>
        </div>
      ))}
    </div>
  )}
</div>

<script>
  import { supabase } from '../lib/supabase'

  const commentsSection = document.querySelector('.comments-section')
  const slug = commentsSection?.getAttribute('data-slug')

  if (slug) {
    async function updateComments() {
      try {
        // Fetch approved comments at runtime
        const { data: comments } = await supabase
          .from('public_comments')
          .select('*')
          .eq('post_slug', slug)
          .order('created_at', { ascending: false })

        const commentCount = comments?.length || 0

        // Update heading
        const headingEl = document.querySelector('.comments-heading')
        if (headingEl) {
          headingEl.textContent = commentCount === 0 ? 'No comments yet' :
                                  commentCount === 1 ? '1 Comment' :
                                  `${commentCount} Comments`
        }

        // Update comments list
        if (commentCount === 0) {
          commentsSection.querySelector('.comments-list')?.remove()
          if (!commentsSection.querySelector('.no-comments')) {
            const noCommentsEl = document.createElement('p')
            noCommentsEl.className = 'no-comments'
            noCommentsEl.textContent = 'Be the first to comment!'
            commentsSection.appendChild(noCommentsEl)
          }
        } else {
          commentsSection.querySelector('.no-comments')?.remove()

          let listEl = commentsSection.querySelector('.comments-list')
          if (!listEl) {
            listEl = document.createElement('div')
            listEl.className = 'comments-list'
            commentsSection.appendChild(listEl)
          }

          // Clear and rebuild comments
          listEl.innerHTML = ''
          comments?.forEach((comment, index) => {
            const commentEl = document.createElement('div')
            commentEl.className = 'comment'

            const date = new Date(comment.created_at).toLocaleString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            })

            commentEl.innerHTML = `
              <div class="comment-header">
                <span class="comment-number">#${commentCount - index}</span>
                <span class="separator">|</span>
                <strong class="comment-author">${comment.author_name}</strong>
                <span class="separator">|</span>
                <time class="comment-date">${date}</time>
              </div>
              <div class="comment-content">${comment.content}</div>
            `

            listEl.appendChild(commentEl)
          })
        }
      } catch (error) {
        console.error('Failed to fetch comments:', error)
      }
    }

    // Update comments on page load
    updateComments()
  }
</script>

<style>
  .comments-section {
    margin: 1.5rem 0;
  }

  .comments-section h3 {
    margin-bottom: 1.5rem;
  }

  :global(.no-comments) {
    color: var(--color-text, #d8d4d6);
    opacity: 0.6;
    font-style: italic;
    font-family: monospace;
  }

  :global(.comments-list) {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-top: 1rem;
  }

  :global(.comment) {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  :global(.comment-header) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--color-border, #404040);
    font-family: monospace;
    font-size: 0.9rem;
  }

  /* :global(.comment-number) { */
  /*   color: var(--color-hyprlink, #75bfff); */
  /*   font-weight: normal; */
  /* } */

  :global(.separator) {
    color: var(--color-text, #d8d4d6);
    opacity: 0.5;
  }

  :global(.comment-author) {
    color: var(--color-text, #d8d4d6);
    font-weight: normal;
  }

  :global(.comment-date) {
    color: var(--color-text, #d8d4d6);
    font-size: 0.9rem;
    font-family: monospace;
  }

  :global(.comment-content) {
    color: var(--color-text, #d8d4d6);
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: inherit;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--color-border, #404040);
    border-top: none;
  }
</style>
