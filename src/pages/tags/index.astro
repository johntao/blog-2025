---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Fetch posts from both collections
const defaultPosts = await getCollection('default');
const aiGeneratedPosts = await getCollection('ai-generated');
const allPosts = [...defaultPosts, ...aiGeneratedPosts];

// Count tags
const tagCounts = new Map<string, number>();
allPosts.forEach(post => {
  post.data.tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

const Unnamed = '_root';

// Group tags by prefix
const groupedTags = new Map<string, Array<{ tag: string; count: number; suffix: string }>>();
tagCounts.forEach((count, tag) => {
  let prefix: string;
  let suffix: string;

  if (tag === '') {
    // Empty string tags (untagged posts)
    prefix = 'notag';
    suffix = Unnamed;
  } else {
    const colonIndex = tag.indexOf(':');
    if (colonIndex !== -1) {
      // Tag has colon: "prefix:suffix"
      prefix = tag.substring(0, colonIndex);
      suffix = tag.substring(colonIndex + 1);
    } else {
      // Tag without colon: use tag as prefix, "_root" as suffix
      prefix = tag;
      suffix = Unnamed;
    }
  }

  const tagData = { tag, count, suffix };

  if (!groupedTags.has(prefix)) {
    groupedTags.set(prefix, []);
  }
  groupedTags.get(prefix)!.push(tagData);
});

// Sort groups and tags within groups, calculate totals
const sortedGroups = Array.from(groupedTags.entries())
  .map(([prefix, tags]) => {
    // Sort: "root" first, then by count descending, then alphabetically
    const sortedTags = tags.sort((a, b) => {
      if (a.suffix === Unnamed && b.suffix !== Unnamed) return -1;
      if (a.suffix !== Unnamed && b.suffix === Unnamed) return 1;
      return b.count - a.count || a.tag.localeCompare(b.tag);
    });
    const totalCount = sortedTags.reduce((sum, tag) => sum + tag.count, 0);
    return {
      prefix,
      tags: sortedTags,
      totalCount
    };
  })
  .sort((a, b) => b.totalCount - a.totalCount || a.prefix.localeCompare(b.prefix));
---

<BaseLayout title="Tags" cls="list1">
  <h2>Tags</h2>
  <p>Browse posts by tags</p>
  <hr />

  <div class="tags-grid">
    {sortedGroups.map(group => (
      <>
        <h3 class="tag-prefix">{group.prefix}({group.totalCount})</h3>
        <ul class="tag-list">
          {group.tags.map(({ tag, count, suffix }) => {
            // Use 'notag' as URL for empty string tags
            const urlTag = tag === '' ? 'notag' : tag;
            return (
              <li>
                <a href={`/tags/${urlTag}`} class="tag-link">
                  {suffix}({count})
                </a>
              </li>
            );
          })}
        </ul>
      </>
    ))}
  </div>
</BaseLayout>

<style>
  .tags-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem 2rem;
    align-items: start;
  }

  .tag-prefix {
    font-size: 1rem;
    margin: 0;
    color: var(--color-purple-l1);
    white-space: nowrap;
  }

  .tag-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .tag-list li {
    margin: 0;
  }

  .tag-link {
    display: inline-block;
  }

  /* Mobile: stack vertically */
  @media (max-width: 768px) {
    .tags-grid {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .tag-prefix {
      margin-bottom: 0.5rem;
    }

    .tag-list {
      margin-bottom: 1.5rem;
    }
  }
</style>
