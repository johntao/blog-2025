---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Fetch posts from both collections
const defaultPosts = await getCollection('default');
const aiGeneratedPosts = await getCollection('ai-generated');
const allPosts = [...defaultPosts, ...aiGeneratedPosts];

// Count tags
const tagCounts = new Map<string, number>();
allPosts.forEach(post => {
  post.data.tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Group tags by prefix
const groupedTags = new Map<string, Array<{ tag: string; count: number }>>();
tagCounts.forEach((count, tag) => {
  const colonIndex = tag.indexOf(':');
  const prefix = colonIndex !== -1 ? tag.substring(0, colonIndex) : 'other';
  const tagData = { tag, count };

  if (!groupedTags.has(prefix)) {
    groupedTags.set(prefix, []);
  }
  groupedTags.get(prefix)!.push(tagData);
});

// Sort groups and tags within groups, calculate totals
const sortedGroups = Array.from(groupedTags.entries())
  .map(([prefix, tags]) => {
    const sortedTags = tags.sort((a, b) => b.count - a.count || a.tag.localeCompare(b.tag));
    const totalCount = sortedTags.reduce((sum, tag) => sum + tag.count, 0);
    return {
      prefix,
      tags: sortedTags,
      totalCount
    };
  })
  .sort((a, b) => b.totalCount - a.totalCount || a.prefix.localeCompare(b.prefix));
---

<BaseLayout title="Tags" cls="list1">
  <h2>Tags</h2>
  <p style="opacity: 0.7; margin-bottom: 2rem;">Browse posts by tags</p>

  <div class="tags-grid">
    {sortedGroups.map(group => (
      <>
        <h3 class="tag-prefix">{group.prefix}({group.totalCount})</h3>
        <ul class="tag-list">
          {group.tags.map(({ tag, count }) => {
            const tagName = tag.substring(tag.indexOf(':') + 1);
            return (
              <li>
                <a href={`/tags/${tag}`} class="tag-link">
                  {tagName}({count})
                </a>
              </li>
            );
          })}
        </ul>
      </>
    ))}
  </div>
</BaseLayout>

<style>
  .tags-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem 2rem;
    align-items: start;
  }

  .tag-prefix {
    font-size: 1rem;
    margin: 0;
    color: var(--color-hyprlink, #75bfff);
    white-space: nowrap;
  }

  .tag-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .tag-list li {
    margin: 0;
  }

  .tag-link {
    display: inline-block;
  }

  /* Mobile: stack vertically */
  @media (max-width: 768px) {
    .tags-grid {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .tag-prefix {
      margin-bottom: 0.5rem;
    }

    .tag-list {
      margin-bottom: 1.5rem;
    }
  }
</style>
